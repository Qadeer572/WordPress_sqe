name: Deploy WordPress to EC2

on:
  push:
    branches:
      - master        
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Optional: Remove this step after you're 100% sure secrets work
      - name: Verify Secrets (Debug)
        run: |
          echo "Host: ${{ secrets.EC2_HOST }}"
          echo "User: ${{ secrets.EC2_USER }}"
          echo "SSH Key: ${{(secrets.EC2_KEY != '') && 'FOUND' || 'MISSING'}}"

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}           # This matches your secret name
          port: 22
          timeout: 60s
          command_timeout: 15m
          script: |
            set -e

            echo "Starting WordPress deployment..."
            cd /var/www/html

            # Pull latest or clone fresh
            if [ -d ".git" ]; then
              echo "Updating existing WordPress site..."
              sudo -u www-data git fetch --all
              sudo -u www-data git reset --hard origin/master
              sudo -u www-data git clean -fd
            else
              echo "First-time deploy — cloning repository..."
              sudo rm -rf /var/www/html/*
              sudo -u www-data git clone https://github.com/Qadeer572/WordPress_sqe.git /var/www/html
            fi

            # Critical: Create wp-config.php if missing
            if [ ! -f wp-config.php ]; then
              echo "wp-config.php not found → creating from sample..."
              sudo -u www-data cp wp-config-sample.php wp-config.php || echo "wp-config-sample.php missing!"
            fi

            # Fix permissions (the WordPress standard)
            sudo chown -R www-data:www-data /var/www/html
            sudo find /var/www/html -type d -exec chmod 755 {} \;
            sudo find /var/www/html -type f -exec chmod 644 {} \;
            sudo chmod -R 775 /var/www/html/wp-content/uploads 2>/dev/null || true

            # Remove problematic .htaccess that breaks Apache
            [ -f .htaccess ] && sudo rm -f .htaccess && echo "Removed broken .htaccess"

            # Enable rewrite module (needed for permalinks)
            sudo a2enmod rewrite || true

            # Test Apache config before restart
            echo "Testing Apache configuration..."
            sudo apache2ctl configtest || echo "Config test failed, but continuing..."

            # Restart Apache safely
            echo "Restarting Apache..."
            sudo systemctl restart apache2 || {
              echo "Apache restart failed — checking logs..."
              journalctl -u apache2 --since "2 minutes ago" | tail -20
              exit 1
            }

            # Final confirmation
            if sudo systemctl is-active --quiet apache2; then
              echo "DEPLOYMENT SUCCESSFUL! WordPress is LIVE!"
              echo "Visit: http://${{ secrets.EC2_HOST }}"
            else
              echo "Apache failed to start"
              sudo systemctl status apache2 --no-pager
              exit 1
            fi