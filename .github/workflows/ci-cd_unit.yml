name: WordPress Unit Tests CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  unit-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Verify Project Structure
        run: |
          echo "Verifying project structure..."
          if [ -f "src/WP_Backend_Helper.php" ]; then
            echo "Helper file found: src/WP_Backend_Helper.php"
          else
            echo "Helper file not found!"
            exit 1
          fi
          
          if [ -f "tests/Backend_UnitTest.php" ]; then
            echo "Test file found: tests/Backend_UnitTest.php"
          else
            echo "Test file not found!"
            exit 1
          fi

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, json, dom, intl
          coverage: xdebug
          tools: composer

      - name: Create composer.json
        run: |
          cat > composer.json << 'EOF'
          {
            "name": "wordpress-sqe/backend-tests",
            "description": "WordPress Backend Unit Tests",
            "type": "project",
            "require": {
              "php": ">=8.0"
            },
            "require-dev": {
              "phpunit/phpunit": "^10.5"
            },
            "autoload": {
              "classmap": ["src/"]
            },
            "autoload-dev": {
              "classmap": ["tests/"]
            },
            "scripts": {
              "test": "phpunit"
            }
          }
          EOF

      - name: Install Dependencies (Fix Permission Denied!)
        run: |
          echo "Installing Composer dependencies..."
          composer install --no-interaction --prefer-dist --optimize-autoloader --no-progress

          echo "Fixing execute permissions on vendor/bin/* (this fixes the error!)"
          chmod +x vendor/bin/phpunit

          echo "PHPUnit installed successfully:"
          vendor/bin/phpunit --version

      - name: Create phpunit.xml
        run: |
          mkdir -p test-results
          cat > phpunit.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <phpunit xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:noNamespaceSchemaLocation="https://schema.phpunit.de/10.5/phpunit.xsd"
                   bootstrap="vendor/autoload.php"
                   colors="true"
                   cacheDirectory=".phpunit.cache"
                   failOnWarning="true"
                   failOnRisky="true">
              <testsuites>
                  <testsuite name="WordPress Backend Unit Tests">
                      <directory>tests</directory>
                  </testsuite>
              </testsuites>
              <source>
                  <include>
                      <directory suffix=".php">src</directory>
                  </include>
              </source>
              <coverage>
                  <include>
                      <directory suffix=".php">src</directory>
                  </include>
                  <report>
                      <html outputDirectory="coverage-report"/>
                      <text outputFile="php://stdout" showOnlySummary="true"/>
                  </report>
              </coverage>
              <logging>
                  <junit outputFile="test-results/junit.xml"/>
              </logging>
          </phpunit>
          EOF

      - name: Run PHPUnit Tests
        run: |
          echo "Running PHPUnit tests..."
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          vendor/bin/phpunit --testdox --colors=always
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: Generate Full Coverage Report
        if: success()
        run: |
          echo "Generating coverage report..."
          vendor/bin/phpunit --coverage-html coverage-report --coverage-text

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage-report/
          retention-days: 14

      - name: Upload JUnit Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: test-results/
          retention-days: 14

      - name: Test Summary
        if: always()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          if [ ${{ job.status }} == 'success' ]]; then
            echo "ALL TESTS PASSED!"
          else
            echo "SOME TESTS FAILED"
          fi
          echo "Tested: src/WP_Backend_Helper.php"
          echo "With:   tests/Backend_UnitTest.php"
          echo "Reports uploaded as artifacts"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"