name: Cypress E2E Tests

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  cypress-tests:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wordpress
          MYSQL_USER: wpuser
          MYSQL_PASSWORD: wppass
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup PHP 8.1
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mysqli, pdo_mysql, mbstring, xml, ctype, json, tokenizer, dom, zip, gd
          tools: wp-cli
          coverage: none

      - name: Verify PHP Installation
        run: |
          echo "ğŸ” PHP Version:"
          php -v
          echo ""
          echo "ğŸ“¦ Installed Extensions:"
          php -m
          echo ""
          echo "ğŸ› ï¸  WP-CLI Version:"
          wp --version

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Verify Node Installation
        run: |
          echo "ğŸ” Node Version:"
          node -v
          echo ""
          echo "ğŸ“¦ NPM Version:"
          npm -v

      - name: Wait for MySQL to be Ready
        run: |
          echo "â³ Waiting for MySQL service..."
          for i in {1..30}; do
            if mysqladmin ping -h"127.0.0.1" -P"3306" -u"root" -p"root" --silent; then
              echo "âœ… MySQL is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: Configure WordPress Database
        run: |
          echo "ğŸ”§ Configuring WordPress..."
          
          # Check if wp-config-sample.php exists
          if [ ! -f "wp-config-sample.php" ]; then
            echo "âŒ wp-config-sample.php not found!"
            echo "Creating default wp-config.php..."
            cat > wp-config.php << 'EOF'
          <?php
          define( 'DB_NAME', 'wordpress' );
          define( 'DB_USER', 'root' );
          define( 'DB_PASSWORD', 'root' );
          define( 'DB_HOST', '127.0.0.1:3306' );
          define( 'DB_CHARSET', 'utf8mb4' );
          define( 'DB_COLLATE', '' );
          
          define('AUTH_KEY',         'test-auth-key');
          define('SECURE_AUTH_KEY',  'test-secure-auth-key');
          define('LOGGED_IN_KEY',    'test-logged-in-key');
          define('NONCE_KEY',        'test-nonce-key');
          define('AUTH_SALT',        'test-auth-salt');
          define('SECURE_AUTH_SALT', 'test-secure-auth-salt');
          define('LOGGED_IN_SALT',   'test-logged-in-salt');
          define('NONCE_SALT',       'test-nonce-salt');
          
          $table_prefix = 'wp_';
          define( 'WP_DEBUG', false );
          
          if ( ! defined( 'ABSPATH' ) ) {
            define( 'ABSPATH', __DIR__ . '/' );
          }
          
          require_once ABSPATH . 'wp-settings.php';
          EOF
          else
            echo "âœ… Using wp-config-sample.php as template"
            cp wp-config-sample.php wp-config.php
            
            # Update database credentials
            sed -i "s/database_name_here/wordpress/g" wp-config.php
            sed -i "s/username_here/root/g" wp-config.php
            sed -i "s/password_here/root/g" wp-config.php
            sed -i "s/localhost/127.0.0.1:3306/g" wp-config.php
          fi
          
          echo "âœ… wp-config.php configured"

      - name: Install WordPress
        run: |
          echo "ğŸš€ Installing WordPress..."
          wp core install \
            --url="http://127.0.0.1:8080" \
            --title="WordPress CI Test Site" \
            --admin_user="Qadeer572" \
            --admin_password="raza@1214" \
            --admin_email="admin@example.com" \
            --skip-email \
            --allow-root
          
          echo "âœ… WordPress installed successfully"
          
          # Display WordPress info
          echo ""
          echo "ğŸ“Š WordPress Information:"
          wp core version --allow-root
          wp db check --allow-root

      - name: Setup WordPress Test Data (Optional)
        run: |
          echo "ğŸ“ Setting up test data..."
          
          # Create test pages
          wp post create \
            --post_type=page \
            --post_title='Test Page' \
            --post_content='This is a test page for Cypress testing.' \
            --post_status=publish \
            --allow-root
          
          # Create test post
          wp post create \
            --post_type=post \
            --post_title='Test Post' \
            --post_content='This is a test post for Cypress testing.' \
            --post_status=publish \
            --allow-root
          
          echo "âœ… Test data created"

      - name: Start PHP Built-in Server
        run: |
          echo "ğŸŒ Starting PHP development server..."
          nohup php -S 127.0.0.1:8080 > server.log 2>&1 &
          echo $! > server.pid
          
          # Wait for server to start
          echo "â³ Waiting for server to be ready..."
          for i in {1..30}; do
            if curl -s http://127.0.0.1:8080 > /dev/null; then
              echo "âœ… Server is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done
          
          # Verify server is running
          curl -I http://127.0.0.1:8080

      - name: Install Cypress Dependencies
        run: |
          echo "ğŸ“¦ Installing Cypress and dependencies..."
          
          # Check if package.json exists
          if [ ! -f "package.json" ]; then
            echo "Creating package.json..."
            cat > package.json << 'EOF'
          {
            "name": "wordpress-cypress-tests",
            "version": "1.0.0",
            "description": "Cypress E2E tests for WordPress",
            "scripts": {
              "cy:run": "cypress run",
              "cy:open": "cypress open",
              "cy:verify": "cypress verify"
            },
            "devDependencies": {
              "cypress": "^13.6.0"
            }
          }
          EOF
          fi
          
          npm install

      - name: Verify Cypress Installation
        run: |
          echo "ğŸ” Verifying Cypress..."
          npx cypress verify
          npx cypress info

      - name: Create Cypress Configuration
        run: |
          echo "âš™ï¸  Creating Cypress configuration..."
          
          # Update cypress.config.js baseUrl if it exists, or create it
          if [ -f "cypress.config.js" ]; then
            # Update baseUrl to use port 8080 for CI
            sed -i "s|baseUrl:.*|baseUrl: 'http://127.0.0.1:8080',|" cypress.config.js || true
            echo "âœ… Updated cypress.config.js baseUrl"
          else
            cat > cypress.config.js << 'EOF'
          const { defineConfig } = require('cypress')

          module.exports = defineConfig({
            e2e: {
              baseUrl: 'http://127.0.0.1:8080',
              viewportWidth: 1280,
              viewportHeight: 720,
              video: true,
              screenshotOnRunFailure: true,
              setupNodeEvents(on, config) {
                // implement node event listeners here
              },
            },
            env: {
              wpUser: 'Qadeer572',
              wpPassword: 'raza@1214',
            },
          })
          EOF
            echo "âœ… Created cypress.config.js"
          fi

      - name: Create Sample Cypress Tests
        run: |
          echo "ğŸ“ Creating sample Cypress tests..."
          
          # Create cypress directory structure
          mkdir -p cypress/e2e
          mkdir -p cypress/support
          mkdir -p cypress/fixtures
          
          # Create sample test if no tests exist
          if [ ! -f "cypress/e2e/wordpress.cy.js" ]; then
            cat > cypress/e2e/wordpress.cy.js << 'EOF'
          describe('WordPress Basic Tests', () => {
            beforeEach(() => {
              cy.visit('/')
            })

            it('should load the homepage', () => {
              cy.title().should('contain', 'WordPress CI Test Site')
            })

            it('should access the admin login page', () => {
              cy.visit('/wp-admin')
              cy.get('#loginform').should('be.visible')
              cy.get('#user_login').should('be.visible')
              cy.get('#user_pass').should('be.visible')
            })

            it('should login to WordPress admin', () => {
              cy.visit('/wp-login.php')
              cy.get('#user_login').type(Cypress.env('wpUser'))
              cy.get('#user_pass').type(Cypress.env('wpPassword'))
              cy.get('#wp-submit').click()
              cy.url().should('include', '/wp-admin')
              cy.get('#wpadminbar').should('be.visible')
            })

            it('should navigate to posts page', () => {
              // Login first
              cy.visit('/wp-login.php')
              cy.get('#user_login').type(Cypress.env('wpUser'))
              cy.get('#user_pass').type(Cypress.env('wpPassword'))
              cy.get('#wp-submit').click()
              
              // Navigate to posts
              cy.visit('/wp-admin/edit.php')
              cy.contains('Posts').should('be.visible')
            })
          })
          EOF
            echo "âœ… Created sample test: cypress/e2e/wordpress.cy.js"
          fi
          
          # Create support file
          if [ ! -f "cypress/support/e2e.js" ]; then
            cat > cypress/support/e2e.js << 'EOF'
          // Import commands.js
          import './commands'

          // Hide fetch/XHR requests from command log
          Cypress.on('window:before:load', (win) => {
            cy.stub(win.console, 'error').as('consoleError')
            cy.stub(win.console, 'warn').as('consoleWarn')
          })
          EOF
          fi
          
          # Create commands file
          if [ ! -f "cypress/support/commands.js" ]; then
            cat > cypress/support/commands.js << 'EOF'
          // Custom WordPress login command
          Cypress.Commands.add('wpLogin', (username, password) => {
            cy.visit('/wp-login.php')
            cy.get('#user_login').type(username)
            cy.get('#user_pass').type(password)
            cy.get('#wp-submit').click()
            cy.url().should('include', '/wp-admin')
          })

          // Custom WordPress logout command
          Cypress.Commands.add('wpLogout', () => {
            cy.visit('/wp-login.php?action=logout')
            cy.get('a').contains('log out').click()
          })
          EOF
          fi

      - name: Run Cypress Tests
        uses: cypress-io/github-action@v6
        with:
          browser: chrome
          headed: false
          config: baseUrl=http://127.0.0.1:8080
        env:
          CYPRESS_baseUrl: http://127.0.0.1:8080
          CYPRESS_wpUser: Qadeer572
          CYPRESS_wpPassword: raza@1214

      - name: Display Server Logs (on failure)
        if: failure()
        run: |
          echo "ğŸ” PHP Server Logs:"
          cat server.log || echo "No server logs found"

      - name: Upload Cypress Screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots
          path: cypress/screenshots
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload Cypress Videos
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-videos
          path: cypress/videos
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-results
          path: |
            cypress/results
            cypress/reports
          retention-days: 7
          if-no-files-found: ignore

      - name: Stop PHP Server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
            rm server.pid
          fi

      - name: Test Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Cypress E2E Tests Completed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”§ Configuration:"
          echo "   PHP Version: 8.1"
          echo "   Node Version: 20"
          echo "   Base URL: http://127.0.0.1:8080"
          echo ""
          echo "ğŸ“Š Artifacts:"
          echo "   - Cypress Screenshots (on failure)"
          echo "   - Cypress Videos"
          echo "   - Test Results"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"