name: Cypress E2E Tests

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  cypress-tests:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wordpress
          MYSQL_USER: wpuser
          MYSQL_PASSWORD: wppass
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -uroot -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup PHP 8.1
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mysqli, pdo_mysql, mbstring, xml, dom, zip, gd
          tools: wp-cli
          coverage: none

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Wait for MySQL
        run: |
          for i in {1..30}; do
            mysqladmin ping -h 127.0.0.1 -uroot -proot --silent && break
            sleep 2
          done

      # âœ… REQUIRED FIX
      - name: Download WordPress
        run: |
          wp core download --allow-root

      - name: Create wp-config.php
        run: |
          cat > wp-config.php <<'EOF'
          <?php
          define('DB_NAME', 'wordpress');
          define('DB_USER', 'wpuser');
          define('DB_PASSWORD', 'wppass');
          define('DB_HOST', '127.0.0.1:3306');
          define('DB_CHARSET', 'utf8mb4');
          define('DB_COLLATE', '');

          define('AUTH_KEY', 'test');
          define('SECURE_AUTH_KEY', 'test');
          define('LOGGED_IN_KEY', 'test');
          define('NONCE_KEY', 'test');
          define('AUTH_SALT', 'test');
          define('SECURE_AUTH_SALT', 'test');
          define('LOGGED_IN_SALT', 'test');
          define('NONCE_SALT', 'test');

          $table_prefix = 'wp_';
          define('WP_DEBUG', false);

          if (!defined('ABSPATH')) {
            define('ABSPATH', __DIR__ . '/');
          }
          require_once ABSPATH . 'wp-settings.php';
          EOF

      - name: Install WordPress
        run: |
          wp core install \
            --url="http://127.0.0.1:8080" \
            --title="CI Test Site" \
            --admin_user="Qadeer572" \
            --admin_password="raza@1214" \
            --admin_email="admin@test.com" \
            --skip-email \
            --allow-root

      - name: Start PHP Server
        run: |
          php -S 127.0.0.1:8080 -t . > server.log 2>&1 &
          sleep 5
          curl -I http://127.0.0.1:8080

      - name: Install Cypress
        run: |
          cat > package.json <<'EOF'
          {
            "name": "wp-cypress",
            "version": "1.0.0",
            "devDependencies": {
              "cypress": "^13.6.0"
            }
          }
          EOF
          npm install

      - name: Cypress Config
        run: |
          cat > cypress.config.js <<'EOF'
          const { defineConfig } = require("cypress");

          module.exports = defineConfig({
            e2e: {
              baseUrl: "http://127.0.0.1:8080"
            },
            env: {
              wpUser: "Qadeer572",
              wpPassword: "raza@1214"
            }
          });
          EOF

      - name: Cypress Tests
        run: |
          mkdir -p cypress/e2e
          cat > cypress/e2e/wp.cy.js <<'EOF'
          describe('WordPress', () => {
            it('Homepage loads', () => {
              cy.visit('/')
              cy.title().should('contain', 'CI Test Site')
            })

            it('Admin login works', () => {
              cy.visit('/wp-login.php')
              cy.get('#user_login').type('Qadeer572')
              cy.get('#user_pass').type('raza@1214')
              cy.get('#wp-submit').click()
              cy.url().should('include', '/wp-admin')
            })
          })
          EOF

      - name: Run Cypress
        uses: cypress-io/github-action@v6
        with:
          browser: chrome
          headed: false

      - name: Upload Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: cypress/screenshots
          if-no-files-found: ignore

      - name: Upload Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: cypress/videos
          if-no-files-found: ignore
