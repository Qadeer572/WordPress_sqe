# name: Cypress E2E Tests
# on:
#   push:
#     branches: [ master, main ]
#   pull_request:
#     branches: [ master, main ]

# jobs:
#   cypress-tests:
#     runs-on: ubuntu-latest
    
#     services:
#       mysql:
#         image: mysql:5.7
#         env:
#           MYSQL_ROOT_PASSWORD: root
#           MYSQL_DATABASE: wordpress
#         ports:
#           - 3306:3306
#         options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

#     steps:
#       - name: Checkout Repository
#         uses: actions/checkout@v4

#       - name: Setup PHP
#         uses: shivammathur/setup-php@v2
#         with:
#           php-version: '8.1'
#           extensions: mysqli, pdo_mysql, gd, intl, zip
#           tools: wp-cli
      
#       - name: Configure WordPress
#         run: |
#           # Create wp-config.php from sample
#           if [ -f wp-config-sample.php ]; then
#             cp wp-config-sample.php wp-config.php
#           else 
#             echo "::error::wp-config-sample.php not found. Cannot configure WordPress."
#             exit 1
#           fi

#           # Update database details using sed for simplicity in CI env implies standard wp-config
#           # Alternatively use wp-cli config create if wp-config-sample is not reliable, but let's try sample first or wp-cli edit
          
#           # Using wp-cli to set config is safer and cleaner
#           rm wp-config.php # remove the copy we just made to use wp config create instead
          
#           wp config create --dbname=wordpress --dbuser=root --dbpass=root --dbhost=127.0.0.1 --skip-check --extra-php <<PHP
#           define( 'WP_DEBUG', true );
#           define( 'WP_DEBUG_LOG', true );
#           PHP

#       - name: Install WordPress
#         run: |
#           wp core install --url=http://127.0.0.1:8000 --title="WordPress Test" --admin_user=admin --admin_password=password --admin_email=admin@example.com --skip-email

#       - name: Run PHP Server
#         run: |
#           php -S 127.0.0.1:8000 > php_server.log 2>&1 &
#           echo "Server started with PID $!"
#           sleep 3 # Give it a moment to start

#       - name: Wait for WordPress to be ready
#         run: |
#           for i in {1..30}; do
#             if curl -s http://127.0.0.1:8000 > /dev/null; then
#               echo "WordPress is up!"
#               break
#             fi
#             echo "Waiting for WordPress..."
#             sleep 1
#           done

#       - name: Run Cypress Tests
#         uses: cypress-io/github-action@v6
#         with:
#           browser: chrome
#           wait-on: 'http://127.0.0.1:8000'
#         env:
#           CYPRESS_baseUrl: http://127.0.0.1:8000



name: Cypress E2E Tests

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  cypress-tests:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wordpress
          MYSQL_USER: wpuser
          MYSQL_PASSWORD: wppass
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mysqli, pdo_mysql, mbstring, xml, ctype, json, tokenizer, dom, zip, gd
          tools: wp-cli
          coverage: none

      - name: Verify PHP Installation
        run: |
          echo "üîç PHP Version:"
          php -v
          echo ""
          echo "üõ†Ô∏è  WP-CLI Version:"
          wp --version

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Wait for MySQL
        run: |
          echo "‚è≥ Waiting for MySQL..."
          for i in {1..30}; do
            if mysqladmin ping -h"127.0.0.1" -P"3306" -u"root" -p"root" --silent; then
              echo "‚úÖ MySQL is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: Configure WordPress
        run: |
          echo "üîß Configuring WordPress..."
          
          if [ ! -f "wp-config-sample.php" ]; then
            cat > wp-config.php << 'EOF'
          <?php
          define( 'DB_NAME', 'wordpress' );
          define( 'DB_USER', 'root' );
          define( 'DB_PASSWORD', 'root' );
          define( 'DB_HOST', '127.0.0.1:3306' );
          define( 'DB_CHARSET', 'utf8mb4' );
          define( 'DB_COLLATE', '' );
          
          define('AUTH_KEY',         'test-auth-key-'.bin2hex(random_bytes(32)));
          define('SECURE_AUTH_KEY',  'test-secure-auth-key-'.bin2hex(random_bytes(32)));
          define('LOGGED_IN_KEY',    'test-logged-in-key-'.bin2hex(random_bytes(32)));
          define('NONCE_KEY',        'test-nonce-key-'.bin2hex(random_bytes(32)));
          define('AUTH_SALT',        'test-auth-salt-'.bin2hex(random_bytes(32)));
          define('SECURE_AUTH_SALT', 'test-secure-auth-salt-'.bin2hex(random_bytes(32)));
          define('LOGGED_IN_SALT',   'test-logged-in-salt-'.bin2hex(random_bytes(32)));
          define('NONCE_SALT',       'test-nonce-salt-'.bin2hex(random_bytes(32)));
          
          $table_prefix = 'wp_';
          define( 'WP_DEBUG', false );
          
          if ( ! defined( 'ABSPATH' ) ) {
            define( 'ABSPATH', __DIR__ . '/' );
          }
          
          require_once ABSPATH . 'wp-settings.php';
          EOF
          else
            cp wp-config-sample.php wp-config.php
            sed -i "s/database_name_here/wordpress/g" wp-config.php
            sed -i "s/username_here/root/g" wp-config.php
            sed -i "s/password_here/root/g" wp-config.php
            sed -i "s/localhost/127.0.0.1:3306/g" wp-config.php
          fi
          
          echo "‚úÖ wp-config.php configured"

      - name: Install WordPress
        run: |
          echo "üöÄ Installing WordPress..."
          wp core install \
            --url="http://127.0.0.1:8000" \
            --title="WordPress CI Test Site" \
            --admin_user="admin" \
            --admin_password="admin123" \
            --admin_email="admin@example.com" \
            --skip-email \
            --allow-root
          
          echo "‚úÖ WordPress installed"

      - name: Setup WordPress
        run: |
          echo "üìù Setting up WordPress..."
          
          wp rewrite structure '/%postname%/' --allow-root
          wp rewrite flush --allow-root
          
          chmod -R 755 wp-content
          mkdir -p wp-content/uploads
          chmod -R 777 wp-content/uploads
          
          wp post create \
            --post_type=page \
            --post_title='Test Page' \
            --post_content='Test page content' \
            --post_status=publish \
            --allow-root
          
          wp post create \
            --post_type=post \
            --post_title='Test Post' \
            --post_content='Test post content' \
            --post_status=publish \
            --allow-root
          
          echo "‚úÖ WordPress configured"

      - name: Start PHP Server
        run: |
          echo "üåê Starting PHP server..."
          nohup php -S 127.0.0.1:8000 > server.log 2>&1 &
          echo $! > server.pid
          
          for i in {1..30}; do
            if curl -s http://127.0.0.1:8000 > /dev/null; then
              echo "‚úÖ Server is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: Install Dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          
          if [ ! -f "package.json" ]; then
            cat > package.json << 'EOF'
          {
            "name": "wordpress-cypress-tests",
            "version": "1.0.0",
            "scripts": {
              "cy:run": "cypress run",
              "cy:open": "cypress open"
            },
            "devDependencies": {
              "cypress": "^13.6.0"
            }
          }
          EOF
          fi
          
          npm install

      - name: Create Cypress Config
        run: |
          echo "‚öôÔ∏è  Creating Cypress config..."
          
          if [ ! -f "cypress.config.js" ]; then
            cat > cypress.config.js << 'EOF'
          const { defineConfig } = require('cypress')

          module.exports = defineConfig({
            e2e: {
              baseUrl: 'http://127.0.0.1:8000',
              viewportWidth: 1280,
              viewportHeight: 720,
              video: true,
              screenshotOnRunFailure: true,
              videoCompression: 32,
              defaultCommandTimeout: 10000,
              requestTimeout: 10000,
              responseTimeout: 10000,
              pageLoadTimeout: 30000,
              retries: {
                runMode: 2,
                openMode: 0
              },
              setupNodeEvents(on, config) {
                return config
              },
            },
            env: {
              wpUser: 'admin',
              wpPassword: 'admin123',
              wpUrl: 'http://127.0.0.1:8000',
            },
          })
          EOF
          fi

      - name: Setup Cypress Support Files
        run: |
          echo "üìù Setting up Cypress..."
          
          mkdir -p cypress/e2e cypress/support cypress/fixtures
          
          cat > cypress/support/e2e.js << 'EOF'
          import './commands'

          Cypress.on('uncaught:exception', (err, runnable) => {
            console.log('Uncaught exception:', err.message)
            return false
          })
          EOF
          
          cat > cypress/support/commands.js << 'EOF'
          Cypress.Commands.add('wpLogin', (username = 'admin', password = 'admin123') => {
            cy.session([username, password], () => {
              cy.visit('/wp-login.php')
              cy.get('#user_login', { timeout: 10000 }).should('be.visible').clear().type(username)
              cy.get('#user_pass').should('be.visible').clear().type(password)
              cy.get('#wp-submit').click()
              cy.url({ timeout: 15000 }).should('include', '/wp-admin')
            })
          })

          Cypress.Commands.add('wpAdminLogin', () => {
            cy.wpLogin()
            cy.visit('/wp-admin')
            cy.get('#wpadminbar', { timeout: 10000 }).should('be.visible')
          })

          Cypress.Commands.add('wpWaitForAdmin', () => {
            cy.get('#wpadminbar', { timeout: 15000 }).should('be.visible')
            cy.get('#wpbody-content', { timeout: 10000 }).should('be.visible')
          })
          EOF
          
          echo "‚úÖ Cypress configured"

      - name: Run Cypress Tests
        uses: cypress-io/github-action@v6
        with:
          browser: chrome
          headed: false
        env:
          CYPRESS_baseUrl: http://127.0.0.1:8000

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots
          path: cypress/screenshots
          retention-days: 7

      - name: Upload Videos
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-videos
          path: cypress/videos
          retention-days: 7

      - name: Display Logs on Failure
        if: failure()
        run: |
          echo "üîç Server Logs:"
          cat server.log || echo "No logs"

      - name: Cleanup
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
          fi