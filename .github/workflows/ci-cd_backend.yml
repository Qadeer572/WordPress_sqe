name: Backend API and DB Tests CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  backend-tests:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: rootpassword
          MYSQL_DATABASE: wordpress_sqe
          MYSQL_USER: wpuser
          MYSQL_PASSWORD: wppass
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -u root -prootpassword"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    steps:

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Verify MySQL Connection
        run: |
          echo "ğŸ” Testing MySQL connection..."
          for i in {1..30}; do
            if mysqladmin ping -h 127.0.0.1 -P 3306 -u root -prootpassword --silent; then
              echo "âœ… MySQL is ready!"
              break
            fi
            echo "â³ Waiting for MySQL... ($i/30)"
            sleep 2
          done

      - name: Setup MySQL User Permissions
        run: |
          echo "ğŸ”§ Configuring MySQL users..."
          mysql -h 127.0.0.1 -P 3306 -u root -prootpassword <<EOF
          CREATE USER IF NOT EXISTS 'wpuser'@'%' IDENTIFIED BY 'wppass';
          GRANT ALL PRIVILEGES ON wordpress_sqe.* TO 'wpuser'@'%';
          GRANT ALL PRIVILEGES ON wordpress_sqe.* TO 'root'@'%';
          GRANT ALL PRIVILEGES ON wordpress_sqe.* TO 'root'@'localhost';
          FLUSH PRIVILEGES;
          SELECT User, Host FROM mysql.user WHERE User IN ('root', 'wpuser');
          SHOW DATABASES;
          EOF
          echo "âœ… MySQL users configured"

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mysqli, curl, gd, mbstring, xml

      - name: Install WP-CLI
        run: |
          curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
          chmod +x wp-cli.phar
          sudo mv wp-cli.phar /usr/local/bin/wp
          wp --version

      - name: Setup WordPress
        run: |
          echo "ğŸ“¦ Downloading WordPress..."
          wp core download --path=wp --skip-content --force

          echo "ğŸ”§ Creating wp-config.php..."
          wp config create \
            --path=wp \
            --dbname=wordpress_sqe \
            --dbuser=wpuser \
            --dbpass=wppass \
            --dbhost=127.0.0.1:3306 \
            --force

          echo "âš™ï¸ Installing WordPress..."
          wp core install \
            --path=wp \
            --url=http://localhost:8000 \
            --title="TestWP" \
            --admin_user=admin \
            --admin_password=admin123 \
            --admin_email=test@example.com \
            --skip-email

          echo "ğŸ”— Enabling permalinks..."
          wp rewrite structure "/%postname%/" --path=wp
          wp rewrite flush --path=wp

          echo "ğŸ” Enabling Basic Auth for REST API..."
          mkdir -p wp/wp-content/mu-plugins
          cp .github/plugins/enable-basic-auth.php wp/wp-content/mu-plugins/
          echo "âœ… Basic Auth enabled for REST API"

          echo "âœ… WordPress setup complete"

      - name: Start WordPress Server
        run: |
          echo "ğŸš€ Starting WordPress development server..."
          nohup php -S 127.0.0.1:8000 -t wp > server.log 2>&1 &
          sleep 10
          echo "âœ… Server started on http://127.0.0.1:8000"

      - name: Verify WordPress is Running
        run: |
          echo "ğŸ” Testing WordPress server..."
          curl -I http://127.0.0.1:8000 || echo "âš ï¸ Server might not be ready"
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest requests mysql-connector-python pytest-cov python-dotenv

      - name: Run Database Tests (Adil-tests)
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_NAME: wordpress_sqe
          DB_USER: wpuser
          DB_PASS: wppass
        run: |
          echo "ğŸ§ª Running database tests..."
          pytest Adil-tests/test_db_queries.py -v --cov --cov-report=html:coverage-db --cov-report=term || true

      - name: Run API Tests (api-tests)
        env:
          BASE_URL: http://127.0.0.1:8000
          WP_BASE_URL: http://127.0.0.1:8000
          WP_API_ENDPOINT: http://127.0.0.1:8000/index.php?rest_route=/wp/v2
          TEST_USERNAME: admin
          TEST_PASSWORD: admin123
        run: |
          echo "ğŸ§ª Running API tests..."
          pytest api-tests/test_wp_api.py -v --cov --cov-report=html:coverage-api --cov-report=term || true

      - name: Upload Database Coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: db-coverage
          path: coverage-db/

      - name: Upload API Coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: api-coverage
          path: coverage-api/

      - name: Display Test Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Backend Tests Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Database Tests: Completed"
          echo "âœ… API Tests: Completed"
          echo "ğŸ“¦ Coverage reports uploaded as artifacts"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"